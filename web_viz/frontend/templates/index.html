<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="Jeffrey Yoo (@QDataLab in University of Virginia)">
    <!-- <link rel="icon" href="../../favicon.ico"> -->
    <title>TextAttack Webapp Demo</title>
        <!-- Bootstrap core CSS -->
    <link href="{{ url_for('static', filename='bs/css/bootstrap.min.css')}}" rel="stylesheet">
    <!-- Bootstrap slider CSS -->
    <link href="{{ url_for('static', filename='bootstrap-slider.min.css')}}" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="{{ url_for('static', filename='custom.css') }}" rel="stylesheet">
    <!-- Plotly! -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
  </head>

  <body>

    <!-- CSS Style -->
    <style>
      div.padded {
        padding-top: 10px;
      } 
    </style> 

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="index">TextAttack Webapp Demo </a>
        </div>
        
        <div class="collapse navbar-collapse" id="navbarText">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
              <a class="nav-link" href="about">About TextAttack <span class="sr-only">(current)</span></a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container">

      <div class="starter-template">
        <h2>TextAttack Demo</h2>
        <p class="lead"> Select attack settings and type in text to generate an adversarial example. </p>
        
        <div class="input-group">
          <div class="input-group-prepend">
            <span class="input-group-text">Input Text</span>
          </div>
          <input type="text" class="form-control" aria-label="InputString" aria-describedby="InputString" id="InputString">
          <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="button" id="generate_button">Generate Adverserial Sample</button>
          </div>
        </div>

      </div>


      <div class="row">
        <!-- Column 1: Options-->
        <div class="col-md-10">
          <div class="card">
            <div class="card-body">
              <h4 class="card-title"> Options </h4>
              <p class="small" style="font-size:80%;">*Constraints available through recipes.</p>
              
              <h5><div class = "padded"> Model: </div>
                <div class = "padded">
                  <select id="model" class="form-control">
                    <option value="bert-ag-news">BERT AG News Sentiment</option>
                    <option value="bert-imdb">BERT IMDB Sentiment</option>
                    <option value="bert-mr">BERT Movie Review Sentiment</option>
                    <option value="bert-yelp-sentiment">BERT Yelp Sentiment</option>
                    <option value="cnn-ag-news">CNN AG News</option>
                    <option value="cnn-imdb">CNN IMDB Sentiment</option>
                    <option value="cnn-mr">CNN Movie Review Sentiment</option>
                    <option value="cnn-yelp-sentiment">CNN Yelp Sentiment</option>
                    <option value="lstm-ag-news">LSTM AG News Sentiment</option>
                    <option value="lstm-imdb">LSTM IMDB Sentiment</option>
                    <option value="lstm-mr">LSTM Movie Review Sentiment</option>
                    <option value="lstm-yelp-sentiment">LSTM Yelp Sentiment</option>
                  </select>
                </div>
              </h5>

              <h5><div class = "padded"> Attack: </div>
                <div class = "padded">
                  <select id="attack" class="form-control">
                    <option value="greedy-word">Greedy Word</option>
                    <option value="greedy-word-wir">Greedy Word with Importance Ranking</option>
                    <option value="ga-word">Genetic Algorithm</option>
                  </select>
                </div>
              </h5>

              <h5><div class = "padded"> Goal: </div>
                <div class = "padded">
                  <select id="goal" class="form-control">
                    <option value="untargeted-classification"> Untargeted Classification </option>
                    <option value="targeted-classification">Targeted Classifcation</option>
                  </select> 
              </h5>

              <h6 id="target_label_input" style="display:none">
                <div class = "padded"> Target Label: </div>
                <input type="text" placeholder="ex: positive, negative" id="target_label" class="form-control" style="margin-top: 3px;">
              </h5>

              <h5><div class = "padded"> Transformation: </div>
                <div class = "padded">
                  <select id="transformation" class="form-control">
                    <option value="word-swap-embedding">Word Swap - Embedding</option>
                    <option value="word-swap-homoglyph">Word Swap - Homoglyph</option>
                    <option value="word-swap-neighboring-char-swap">Word Swap - Neighboring Character Swap</option>
                  </select>
                </div>
              </h5>

              <h5><div class = "padded"> Recipe (Optional): </div>
                <p class="small" style="font-size:60%;">*Recipe represents settings of goal, transformation, constraints replicated from papers. Setting it overrides your selection of goal and transformation</p>
                  <select id="recipe" class="form-control">
                    <option value="none" > None </option>
                    <option value="alzantot">Alzantot 2018 - Genetic Algorithm</option>
                    <option value="alz-adjusted">Alzantot 2018 - Genetic Algorithm Adjusted</option>
                    <option value="textfooler">Jin 2019 - TextFooler</option>
                    <option value="tf-adjusted">Jin 2019 - TextFooler Adjusted</option>
                  </select>
              </h5>

            </div>
          </div>
        </div>


        <!-- Result display -->
        <div class="col-md-10">

          <!-- Default display -->
          <div id="default-display" class="card" style="height: 38rem; display: "";">
            <div class="card-body">
                <div id="loading-display" style="text-align: center; display: none;">
                  <br></br> <br></br> <br></br>
                  <div class="loader"></div> 
                  <h5 style="color: #696966;">
                    <strong>Generated Attacking input...
                  </strong></h5>
                </div>
            </div>
          </div>

          <!-- show orginal result display -->
          <div id="result-display" class="card"  style="height: 38rem; display: none;">
            <div class="card-body">

              <div id="original_input_display" class="row">
                <h5 style="margin-right: 3px;"> Original Label: </h5>
                <div style="font-size:20px; margin-top: -2.5px; margin-right:6px;" id="original_label"> Positive</div>
                <h5 style="width:100%;">Original Input:</h5>
                <div id="original_text"></div> 

                <!-- BELOW ADDED BY QYJ / For visualization -->
                <br><br><h5 style="width:100%;">Original Score:</h5>
                <canvas id="original_score" width="800" height="450"></canvas>
              </div>

              <br><hr><hr><br>

              <div id="attacked_input_display" class="row">
                <h5 style="margin-right: 3px;"> Perturbed Label: </h5>
                <div style="font-size:20px; margin-top: -2.5px; margin-right:6px;" id="perturbed_label"> Positive</div>
                <br><h5 style="width:100%;">Perturbed Input:</h5>
                <div id="perturbed_text"></div>

                <!-- BELOW ADDED BY QYJ / For visualization -->
                <br><br><h5 style="width:100%;">Perturbed Score: </h5>
                <canvas id="perturbed_score" width="800" height="450"></canvas>
              </div>

              <br><hr><hr><br>

              <!-- BELOW ADDED BY QYJ / For visualization -->
              <div id="combine_display" class="row">
              <canvas id="combine_scores" width="800" height="450"></canvas>
              </div>

            </div> <!-- end of card -body -->
          </div> <!-- end of card  --> 

        </div> <!-- end of col -->
      </div> <!-- end of row -->

    </div> <!-- end of container -->

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="{{ url_for('static', filename='image-picker/image-picker/image-picker.min.js')}}"></script>

    <script>
      function refresh_display()
      {
        if (document.getElementById('loading-display').style.display != "none") {
          document.getElementById('loading-display').style.display = "none";
        }
        if (document.getElementById('result-display').style.display != "none") {
          document.getElementById('result-display').style.display = "none";
        }
        document.getElementById('default-display').style.display = "";

      }

      function load_spinner_display()
      {
        document.getElementById('loading-display').style.display ="";
      }

      function draw_score(original_v, perturbed_v, class_names)
      {
        // Bar chart
        new Chart(document.getElementById("combine_scores"), {
          type: 'bar',
          data: {
              labels: class_names,
              datasets: [
                {
                  label: "Original",
                  backgroundColor: "#3e95cd",
                  data: original_v
                }, {
                  label: "Perturbed",
                  backgroundColor: "#8e5ea2",
                  data: perturbed_v
                }
              ]
            },          
          options: {
            title: {
              display: true,
              text: 'Predicted Score Vectors (before and after perturbation)'
            }, 
            scales: {
                yAxes : [{
                    ticks : {
                        max : 1,    
                        min : -0.1
                    }
                }]
            }
          }
        }); 
      }

      function draw_score_each(original_v, perturbed_v, class_names)
      {
        var chart_layout = {
            title: {
              display: true,
              text: 'Predicted Score Vectors'
            }, 
            scales: {
                yAxes : [{
                    ticks : {
                        max : 1,    
                        min : -0.1
                    }
                }]
            }
        }

        // Bar chart
        new Chart(document.getElementById("original_score"), {
          type: 'bar',
          data: {
              labels: class_names,
              datasets: [
                {
                  label: "Original",
                  backgroundColor: "#3e95cd",
                  data: original_v
                }
              ]
            },          
          options: chart_layout
        }); 

        // Bar chart
        new Chart(document.getElementById("perturbed_score"), {
          type: 'bar',
          data: {
              labels: class_names,
              datasets: [
                {
                  label: "Perturbed",
                  backgroundColor: "#8e5ea2",
                  data: perturbed_v
                }
              ]
            },          
          options: chart_layout
        }); 
      }

      function load_attack_result_display(result)
      {
        console.log("loading attack result...")
        if (document.getElementById('default-display').style.display != "none") {
          document.getElementById('default-display').style.display = "none";
        }
        if (document.getElementById('loading-display').style.display != "none") {
          document.getElementById('loading-display').style.display = "none"
        }

        console.log(result);
        var success = result["success"];
        if (result["success"]) {
            document.getElementById("original_label").innerHTML = result["original_label"];
            document.getElementById("perturbed_label").innerHTML = result["perturbed_label"];
            document.getElementById("original_text").innerHTML = result["original_text"];
            document.getElementById("perturbed_text").innerHTML = result["perturbed_text"];

            draw_score(result["original_score"], result["perturbed_score"], result["out_names"]);
            draw_score_each(result["original_score"], result["perturbed_score"], result["out_names"]);

        } else {
            document.getElementById("original_label").innerHTML = result["original_label"];
            document.getElementById("original_text").innerHTML = result["original_text"];
            document.getElementById("attacked_input_display").innerHTML = '<h5 style="color:#e00d0d;">Attack failed</h5>';
        } 
  
        document.getElementById('result-display').style.display = "";
      };


      $(document).ready(function(){

          $('#goal').change(function () {
              if ($(this).val() == "targeted-classification") {
                  var model = document.getElementById("model").value;
                  if (model.includes("ag-news")) {
                    document.getElementById("target_label").placeholder= "ex: World, Sports, Business, Sci/Tech";
                  }
                  document.getElementById("target_label_input").style.display = "";
              }
          })

          $('#model').change(function () {
              if (document.getElementById("goal").value == "targeted-classification") {
                  if($(this).val().includes("ag-news")) {
                    document.getElementById("target_label").placeholder= "ex: World, Sports, Business, Sci/Tech";
                  } else {
                    document.getElementById("target_label").placeholder= "ex: positive, negative";
                  }
              }
                  
          })

          $('input[type="text"]').on('keyup', function (e){
            if (e.keyCode === 13) {
              document.getElementById("generate_button").click();
            }
          });

          $("#generate_button").click(function(){
            refresh_display();

            load_spinner_display();

            var input_string = document.getElementById("InputString").value;
            var model = document.getElementById("model").value;
            var attack = document.getElementById("attack").value;
            var goal = document.getElementById("goal").value;
            var target_label = "";
            var recipe = document.getElementById("recipe").value;
            var transformation = document.getElementById("transformation").value;

            if (goal == "targeted-classification") {
              target_label = document.getElementById("target_label").value;
            }

            load_spinner_display();

            $.post("run_textattack",
              {
                input_string    : input_string, 
                model : model,
                attack : attack,
                goal : goal,
                target_label : target_label,
                transformation : transformation,
                recipe: recipe
              },
              load_attack_result_display,
              "json"
            );
          });
        });

    </script>
    
    <script src="{{ url_for('static', filename='bs/js/bootstrap.min.js') }}"></script>
    <script src="{{ url_for('static', filename='bootstrap-slider.min.js') }}"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!--<script src="{{ url_for('static', filename='bs/js/ie10-viewport-bug-workaround.js')}}"></script>-->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-100959649-1', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>
